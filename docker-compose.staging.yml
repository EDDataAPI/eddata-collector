version: '3.8'

services:
  eddata-collector:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: ghcr.io/eddataapi/eddata-collector:staging
    container_name: eddata-collector-staging
    restart: unless-stopped
    ports:
      - "${EDDATA_COLLECTOR_PORT:-3003}:3002"
    volumes:
      - eddata-staging-data:/app/eddata-data
      - eddata-staging-backup:/app/eddata-backup
      - eddata-staging-downloads:/app/eddata-downloads
      - eddata-staging-logs:/app/logs
      - ./eddata.staging.config:/app/eddata.config:ro
    environment:
      - NODE_ENV=staging
      - EDDATA_COLLECTOR_LOCAL_PORT=3002
      - EDDN_SERVER=${EDDN_SERVER:-tcp://eddn.edcd.io:9500}
      - EDDATA_DOMAIN=${EDDATA_DOMAIN:-staging-eddata.api.com}
      - EDDATA_DOWNLOADS_BASE_URL=${EDDATA_DOWNLOADS_BASE_URL}
      - EDDATA_DATA_DIR=/app/eddata-data
      - EDDATA_CACHE_DIR=/app/eddata-data/cache
      - EDDATA_BACKUP_DIR=/app/eddata-backup
      - EDDATA_DOWNLOADS_DIR=/app/eddata-downloads
      # Staging-specific configuration
      - LOG_LEVEL=${LOG_LEVEL:-debug}
      - MAINTENANCE_DAY_OF_WEEK=${MAINTENANCE_DAY_OF_WEEK:-6}
      - MAINTENANCE_WINDOW_START_HOUR=${MAINTENANCE_WINDOW_START_HOUR:-1}
      - MAINTENANCE_WINDOW_END_HOUR=${MAINTENANCE_WINDOW_END_HOUR:-3}
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3002/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "5"
    networks:
      - eddata-staging-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.eddata-collector-staging.rule=Host(`staging-collector.eddata.api.com`)"
      - "traefik.http.services.eddata-collector-staging.loadbalancer.server.port=3002"
      - "environment=staging"
      - "service=eddata-collector"

volumes:
  eddata-staging-data:
    driver: local
  eddata-staging-backup:
    driver: local
  eddata-staging-downloads:
    driver: local
  eddata-staging-logs:
    driver: local

networks:
  eddata-staging-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16